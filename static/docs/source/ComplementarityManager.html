<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Workspace-objects-secondary-ComplementarityManager'>/**
</span> * Allows centralized management of {@link Workspace.objects.Object objects}, 
 * many of which may have complementarity or equality relationships between
 * their abstract identities. For instance, this could be used to manage the 
 * names (identities) of segments or domains in a secondary structure system,
 * or ports in a Nodal system. 
 */
Ext.define(&quot;Workspace.objects.secondary.ComplementarityManager&quot;, {
	extend : 'Workspace.objects.Object',
	nameIndex: -1,
	defaultPolaritySpecifier: &quot;*&quot;,
<span id='Workspace-objects-secondary-ComplementarityManager-cfg-colorProperty'>	/**
</span>	 * @cfg
	 * Color-related property which should be managed by this class. 
	 * See #getColor and #setColor
	 */
	colorProperty : &quot;stroke&quot;,
	constructor : function() {
		this.callParent(arguments);
		this.identities = {};
		this.colors = {};
		this.objectIdentitiesCache = {};
		this.expose('identities',true,true,true,false);
		this.expose('nameIndex',true,true,true,false);
		this.workspace.complementarityManager = this;
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-makeIdentifier'>	/**
</span>	 * Forms an identifier string consisting of a name and an optional 
	 * polarity specifier
	 * @param {String} name,
	 * @param {Number} polarity
	 * @return {String} identifier
	 */
	makeIdentifier: function(name,polarity) {
		return name + ((polarity == -1) ? this.defaultPolaritySpecifier : ''); 
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-getIdentity'>	/**
</span>	 * Provides the identity of an object
	 * @param {Workspace.objects.Object} object
	 * @return {String} identity
	 */
	getIdentity : function(object) {
		if(object &amp;&amp; object.getId) return this.objectIdentitiesCache[object.getId()];
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-getIdentifier'>	/**
</span>	 * Provides the identifier string (identity + polarity) for an object
	 * @param {Workspace.objects.Object} object
	 * @param {Number} [polarity=1] Optionally flip the polarity the object in the identifier
	 * @return {String} identifier
	 */
	getIdentifier : function(object,polarity) {
		polarity || (polarity = 1);
		if(object &amp;&amp; object.getId) return this.makeIdentifier(this.getIdentity(object),object.get('polarity')*polarity);
	},
	getColor : function(identifier) {
		return this.colors[identifier];
	},
	setColor : function(identifier,value) {
		var old = this.colors[identifier]; 
		this.colors[identifier] = value;
		_.each(this.getWithIdentity(identifier),function(obj) {
			obj.change(this.colorProperty,value,old);
		},this)
	},
	nextColor : function() {
		return Workspace.Utils.ideaColor(this.getId());
	},
	nextName : function() {
		var s = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		this.nameIndex++;
		var r = '', n = this.nameIndex;
		do {
			r = r + s.charAt(n % 26);
			n -= 25;
		} while(n&gt;0)
		return r;
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-checkoutIdentity'>	/**
</span>	 * Generates, reserves, or adds a new identity for an object.
	 */
	checkoutIdentity: function(object,id) {
		id = id || this.nextName();
		id = this.normalizeIdentity(id);
		if(!this.identities[id]) {
			this.identities[id] = [];
			this.colors[id] = this.nextColor();
		}
		this.cacheObjectId(object,id);
		this.identities[id].push(object);
		object.set('polarity',this.getPolarity(id));
		return id;
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-normalizeIdentity'>	/**
</span>	 * Strips the polarity indicator (* or ') from an identifier
	 * @param {String} identifier 
	 */
	normalizeIdentity: function(identifier) {
		if(this.getPolarity(identifier)==-1) {
			return identifier.substring(0,identifier.length - 1);
		}
		return identifier;
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-getWithIdentity'>	/**
</span>	 * Gets objects which have the given identity (of either polarity)
	 * @return {Workspace.objects.Object[]} objects
	 */
	getWithIdentity: function(identifier) {
		identifier = this.normalizeIdentity(identifier);
		return this.identities[identifier];
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-getPolarity'>	/**
</span>	 * Gets the polarity of a given identifier string. Strings ending with * or
	 * ' are assumed to have negative (3' to 5') polarity.
	 * @param {String} identifier
	 * @return {Number} polarity 1 for 5' -&gt; 3', -1 for 3' -&gt; 5'
	 */
	getPolarity: function(identifier) {
		return identifier ? ((identifier[identifier.length - 1] == '*' || identifier[identifier.length - 1] == &quot;'&quot;) ? -1 : 1) : 0;
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-getEqual'>	/**
</span>	 * Returns all objects with a given identity and polarity
	 * @param {String} identifier
	 * @param {Number} polarity 1 for 5' -&gt; 3', -1 for 3' -&gt; 5'
	 * @return {Workspace.objects.Object[]} objects
	 */
	getEqual: function(identifier,polarity) {
		if(polarity == 0) {
			polarity = this.getPolarity(identifier);
		}
		var ids = this.getWithIdentity(identifier);
		return _.filter(ids,function(object) {
			return object.get('polarity')==polarity;
		});
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-getComplementary'>	/**
</span>	 * Returns all objects with a given identity and the opposite polarity
	 * to that given.
	 * @param {String} identifier
	 * @param {Number} polarity 1 for 5' -&gt; 3', -1 for 3' -&gt; 5'
	 * @return {Workspace.objects.Object[]} objects
	 */
	getComplementary: function(identifier,polarity) {
		if(polarity==0) polarity = this.getPolarity(identifier);
		return this.getEqual(identifier,polarity*-1);
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-cacheObjectId'>	/**
</span>	 * Updates a cache which maintains the identity associated with each object 
	 * by {@link Machine.core.Serializable#id InfoMachine object ID}. This 
	 * allows fast lookup of object identity within #getIdentity.
	 * @private
	 */
	cacheObjectId: function(object,identity) {
		this.objectIdentitiesCache[object.getId()] = identity;
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-mergeIdentifiers'>	/**
</span>	 * Merges the right identity into the left identity. Updates the identity 
	 * and polarity of all strands with the right identity to match that of 
	 * the left.
	 * @param {String} left Left Identity
	 * @param {String} right Right Identity
	 */
	mergeIdentifiers: function(left,right) {
		var leftId = left ? this.normalizeIdentity(left) : false,
			leftPol = left ? this.getPolarity(left) : false,
			rightId = right ? this.normalizeIdentity(right) : false,
			rightPol = right ? this.getPolarity(right) : false;
		var newEqualStrands,newComplementStrands, newStrands;
		
		if(leftId &amp;&amp; this.identities[leftId]) {
			newEqualStrands = this.getEqual(rightId,rightPol);
			newComplementStrands = this.getComplementary(rightId,rightPol);
			newStrands = newEqualStrands.concat(newComplementStrands);
			
			this.identities[leftId] = this.identities[leftId].concat(newStrands);
			
			_.each(newEqualStrands,function(strand) {
				strand.set('polarity',leftPol);
				this.cacheObjectId(strand,leftId);
				strand.change('identity',leftId,rightId);
			},this);
			
			_.each(newComplementStrands,function(strand) {
				strand.set('polarity',-leftPol);
				this.cacheObjectId(strand,leftId);
				strand.change('identity',leftId,rightId);
			},this);
		}
	},
<span id='Workspace-objects-secondary-ComplementarityManager-method-makeComplementary'>	/**
</span>	 * Makes two objects complementary by merging their identities. Merges are 
	 * left to right; all objects with the identity of the right object will 
	 * become left*, while all objects with the right* will become left. 
	 * @param {String} left Left object
	 * @param {String} right Right object
	 */
	makeComplementary: function(left,right) {
		this.mergeIdentifiers(this.getIdentifier(left),this.getIdentifier(right,-1));
	},
	
}, function() {
	Workspace.reg('Workspace.objects.secondary.ComplementarityManager', Workspace.objects.secondary.ComplementarityManager);
})</pre>
</body>
</html>
