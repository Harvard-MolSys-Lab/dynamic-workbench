<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='App-usr-dil-Complex'>/**
</span> * @class
 * Record defining a complex. Use with App.usr.dil.ComplexStore
 */
Ext.define('App.usr.dil.Complex', {
	extend: 'Ext.data.Model',
	requires: ['App.usr.dil.StrandStore','App.usr.dil.SegmentStore'],
<span id='App-usr-dil-Complex-property-fields'>	fields: [{
</span>		name: 'id',
		type: 'int'
	}, {
		name: 'name'
	}, {
		name: 'polarity',
		type: 'int'
	}, {
		name: 'strands' // array
	}, {
		name: 'specs',
		// array
	}, {
		name: 'sequences',
		// array
	}, {
		name: 'structure'
	}, ],
<span id='App-usr-dil-Complex-property-idgen'>	idgen: 'sequential',
</span><span id='App-usr-dil-Complex-method-getDynaml'>	getDynaml: function(lib) {
</span>		return lib.getNode(this.get('name'));
	},
<span id='App-usr-dil-Complex-method-getStrands'>	getStrands: function() {
</span>		return this.get('strands');
	},
<span id='App-usr-dil-Complex-method-getStructures'>	getStructures: function() {
</span>		var structures = this.get('structure') || '';
		return  _.map(structures.split('+'), function(s) {
			return s.trim();
		});
	},
<span id='App-usr-dil-Complex-method-fixStructure'>	fixStructure: function(strandIndex,added,removed) {
</span>		var structures = this.getStructures(),
			struct = structures[strandIndex];
		if(struct) {
			struct = struct.split('');
			for(var i=struct.length-1; i&gt;=0; i--) {
				if(removed.indexOf(i) != -1) {
					delete struct[i];
				}
				if(added.indexOf(i) != -1) {
					struct.splice(i,0,'.');
				}
			}
			structures[strandIndex] = _.compact(struct).join('');
			this.set('structure',structures.join('+'));
		}
	},
<span id='App-usr-dil-Complex-property-proxy'>	proxy: 'memory',
</span>});

<span id='App-usr-dil-ComplexStore'>/**
</span> * Store representing a collection of {@link App.dynamic.Complex DyNAML complexes}.
 */
Ext.define('App.usr.dil.ComplexStore', {
	extend: 'Ext.data.Store',
<span id='App-usr-dil-ComplexStore-property-model'>	model: 'App.usr.dil.Complex',
</span><span id='App-usr-dil-ComplexStore-method-constructor'>	constructor: function() {
</span>		this.callParent(arguments);
		if(this.strandStore) {
			this.strandStore.on('update', function(segmentStore, rec, op, modifiedFieldNames) {
				if(modifiedFieldNames.indexOf('sequence') != -1 || modifiedFieldNames.indexOf('spec') != -1) {
					this.updateComplexes();
				}
			}, this);
		}
	},

<span id='App-usr-dil-ComplexStore-method-updateComplexes'>	updateComplexes: function(changedStrand) {
</span>		var strandSpecs = {},
			strandSeqs = {},
			strands = this.strandStore.getRange(),
			complexes = this.getRange();
		for(var i = 0; i &lt; strands.length; i++) {
			var strand = strands[i],
				name = strand.get('name');
			strandSpecs[name] = strand.get('spec');
			strandSeqs[name] = strand.get('seq');
		}

		var changedStrandName = changedStrand ? changedStrand.get('name') : null;
		for(var i = 0; i &lt; complexes.length; i++) {
			var complex = complexes[i],
				complexStrands = complex.get('strands'),
				spec = [],
				seqs = [],
				struct = null,
				diffSpec = null;
			for(var j = 0; j &lt; complexStrands.length; j++) {
				var strandName = complexStrands[j];
				
				// if(strandName == changedStrandName) {
				// 	var oldSpec = complex.get('spec')[j];
				// 	if(!diffSpec) {
				// 		diffSpec = changedStrand.diffSpec(oldSpec);
				// 	}

				// }
				spec.push(strandSpecs[strandName]);
				seqs.push(strandSeqs[strandName]);
			}
			complex.beginEdit();
			complex.set('spec', spec);
			complex.set('seqs', seqs);
			complex.endEdit();
		}
	},

<span id='App-usr-dil-ComplexStore-method-addComplex'>	/**
</span>	 * Adds a new complex to this store, automatically naming it
	 * @return {App.usr.dil.Complex} The newly added complex
	 */
	addComplex: function() {
		var name = _.max(_.map(this.getRange(), function(rec) {
			var k = rec.get('name').match(/\d+/g);

			return (!!k &amp;&amp; k.length &gt; 0 &amp;&amp; !isNaN(k[0])) ? k : 0;
		}));
		name &lt; 0 ? (name = 0) : name;
		var existing;
		do {
			name+=1;
			existing = this.find('name',name);	
		} while (existing != -1)

		return this.add({
			name: 'n'+name,
			strands: [],
			specs: [],
			struture: '',
		});
	},
});
</pre>
</body>
</html>
