<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='App-ui-MultisubjectiveViewer'>/**
</span> * Allows viewing of scripts for the NUPACK multi-objective designer
 */
Ext.define('App.ui.MultisubjectiveViewer', {
	extend : 'App.ui.D3Panel',
	mixins : {
		app : 'App.ui.Application'
	},
	iconCls : 'ms-icon',
	editorType : 'MS',
	alias : 'widget.multisubjectiveview',
	requires : ['App.ui.SequenceThreader', 'App.ui.NupackMenu'],
	dockedItems : [{
		xtype : 'cite',
		cite : {
			authors : ['John P. Sadowski', 'Peng Yin'],
			title : 'Multisubjective: better nucleic acid design through fast identification and removal of undesired secondary structure',
			publication : 'Unpublished'
		},
	}],

	autoRender : false,
	constructor : function() {
		this.callParent(arguments);
		this.mixins.app.constructor.apply(this, arguments);
		this.on('afterrender', this.loadFile, this);
	},
	onLoad : function() {
		this.afterrender();
	},
	buildVis : function() {
		var data = JSON.parse(this.data);
		var panel = this.getCanvas();

		/*
		 &quot;immutable&quot;:[17,308,309, ... ]
		 */

		var immutable = _.reduce(data['immutable'], function(memo, i) {
			memo[i] = true;
			return memo;
		}, {});

		/*
		 &quot;desired&quot;:[
		 {&quot;pair&quot;:[17,71]},
		 {&quot;pair&quot;:[18,70]},
		 ...
		 ]
		 */

		var desired = _.reduce(data['desired'], function(memo, p) {
			if (!memo[p.pair[1]])
				memo[p.pair[0]] = p.pair[1];
			return memo;
		}, {});

		/*
		 &quot;undesired&quot;:[
		 {&quot;pair&quot;:[4,15]},
		 {&quot;pair&quot;:[5,14], &quot;changed&quot;:{&quot;5&quot;:&quot;N&quot;}},
		 {&quot;pair&quot;:[193,211], &quot;warning&quot;:{&quot;type&quot;:-1, &quot;pos&quot;:[193,211]},
		 ...
		 ]
		 */

		var undesired = _.reduce(data['undesired'], function(memo, p) {
			var o = _.clone(p);
			o.target = p.pair[1];
			if (!memo[p.pair[1]]) {
				memo[p.pair[0]] = o
			}
			return memo;
		}, {})
		/*
		 &quot;prevented&quot;:[
		 {&quot;range&quot;:[1,4], &quot;identity&quot;:&quot;G&quot;, &quot;changed&quot;:{&quot;4&quot;:&quot;H&quot;}},
		 {&quot;range&quot;:[2,5], &quot;identity&quot;:&quot;A&quot;},
		 ]
		 */

		var prevented = _.reduce(data['prevented'], function(memo, p) {
			_.each(_.range(p.range[0], p.range[1]), function(i) {
				memo[i] = p;
			});
			return memo;
		}, {});

		/*
		 &quot;basecollide&quot;:[
		 {&quot;warning&quot;:{&quot;type&quot;:-5, &quot;pos&quot;:[2,0]},
		 {&quot;warning&quot;:{&quot;type&quot;:-5, &quot;pos&quot;:[11,4]},
		 ]
		 */

		/*
		 &quot;strands&quot;:[
		 { &quot;name&quot;:&quot;A1&quot;, &quot;length&quot;:79, &quot;range&quot;:[1,79] },
		 { &quot;name&quot;:&quot;A2&quot;, &quot;length&quot;:79, &quot;range&quot;:[80,158] },
		 ]
		 */
		var nodes = [];
		var strand_links = [];
		var undesired_links = [];
		var desired_links = [];

		_.each(data['strands'], function(s, i) {
			// i = strand index

			_.each(_.range(s.range[0], s.range[1]), function(j, k) {
				// j = absolute base index
				// k = strand-wise base index

				var node = {
					abs_index : j,
					strand_index : i,
					strand : s.name
				};

				// immutable
				if (immutable[j]) {
					node.immutable = true;
				}

				// prevented
				if (prevented[j]) {
					node.prevented = prevented[j].identity;
				}
				nodes.push(node);

				// desired
				if (desired[j]) {
					desired_links.push({
						source : j,
						target : desired[j],
						_type : 'desired'
					});
				}

				// undesired
				if (undesired[j]) {
					var l = {
						source : j,
						target : undesired[j].target,
						_type : 'undesired'
					}
					if (undesired[j].changed) {
						l.changed = undesired[j].changed;
					}
					undesired_links.push(l);
				}

				if (k &lt; (strand.length - 1)) {
					strand_links.push({
						source : j,
						target : j + 1,
						_type : 'strand'
					})
				}
			});
		});
		
		
		var links = desired_links.concat(strand_links);
		

		panel.call(d3.behavior.zoom());

		this.force = d3.layout.force().charge(-100).linkDistance(20)
		.size([this.getWidth(), this.getHeight()])
		.linkStrength(function(l,i) {
			if(l._type == 'strand') {
				return 0.7
			} else {
				return 0.4
			}
		}).gravity(0.01);

		this.force.nodes(allNodes).links(links).start();

		var line_stroke = '#aaa';

		// Links
		this.link = panel.selectAll(&quot;line.link&quot;).data(links).enter().append(&quot;line&quot;).attr(&quot;class&quot;, function(d) {
			var cls = [&quot;link&quot;]
			cls.push(&quot;source-&quot; + d.source.name);
			cls.push(&quot;target-&quot; + d.target.name);
			return cls.join(' ');
		})
		.style(&quot;stroke-width&quot;, 2)
		.style('stroke', line_stroke);

		// Node Groups
		this.node = panel.selectAll(&quot;g.node&quot;).data(allNodes).enter().append('g').attr(&quot;class&quot;, &quot;node&quot;)
		.call(this.force.drag);
		
		// Node circle

		this.node.append(&quot;circle&quot;).attr(&quot;r&quot;, 5)
		.style(&quot;fill&quot;, '#aaa')
		.attr('stroke-width', 2)
		.attr('stroke', '#fff')

		// Node text
		this.node.append('text').attr('class', 'node_label')
		//.style('stroke','#111')
		.style('fill', '#111')//.style('text-shadow','1px 1px 2px #222')
		.style('text-shadow', '2px 2px 2px white')
		//.attr('text-anchor','middle').attr('dy','.35em')
		.attr(&quot;dx&quot;, function(d) {
			return radius(d) + 5
		}).attr(&quot;dy&quot;, &quot;.35em&quot;).text(function(d) {
			return ''
		});
		
		
		
		var me = this;
		this.force.on(&quot;tick&quot;, function() {
			me.link.attr(&quot;x1&quot;, function(d) {
				return d.source.x;
			}).attr(&quot;y1&quot;, function(d) {
				return d.source.y;
			}).attr(&quot;x2&quot;, function(d) {
				return d.target.x;
			}).attr(&quot;y2&quot;, function(d) {
				return d.target.y;
			});
			// me.link.attr(&quot;d&quot;, function(d) {
			// var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y, dr = Math.sqrt(dx * dx + dy * dy);
			// return &quot;M&quot; + d.source.x + &quot;,&quot; + d.source.y + &quot;A&quot; + dr + &quot;,&quot; + dr + &quot; 0 0,1 &quot; + d.target.x + &quot;,&quot; + d.target.y;
			// });
			
			me.node.attr(&quot;transform&quot;, function(d) { return &quot;translate(&quot; + d.x + &quot;,&quot; + d.y + &quot;)&quot;; });
			// me.node.attr(&quot;cx&quot;, function(d) {
				// return d.x;
			// }).attr(&quot;cy&quot;, function(d) {
				// return d.y;
			// });
// 			
			// me.node_label.attr(&quot;x&quot;, function(d) {
				// return d.x;
			// }).attr(&quot;y&quot;, function(d) {
				// return d.y;
			// });
		});
	},
	initComponent : function() {

		this.callParent(arguments);
	},
})</pre>
</body>
</html>
