<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">if(!App)
	var App = {
		name : 'DyNAMiC Workbench'
	};

function msg(message) {
	return function() {
		if(!!message)
			Ext.Msg.show({
				title : 'Admin',
				msg : message,
				buttons : Ext.Msg.OK,
				iconCls : 'lock'
			});
	};
}

Ext.onReady(function() {

	Ext.QuickTips.init();
	Ext.form.Field.prototype.msgTarget = 'side';

	Ext.require('Ext.ux.CheckColumn');

	Ext.define('App.model.User', {
		extend : 'Ext.data.Model',
		fields : [{
			name : '_id',
			type : 'string'
		}, {
			name : 'name',
			type : 'string'
		}, {
			name : 'email',
			type : 'string'
		}, {
			name : 'institution',
			type : 'string',
		}, {
			name : 'active',
			type : 'bool'
		}, {
			name : 'admin',
			type : 'bool'
		},],
	})

	var store = Ext.create('Ext.data.Store', {
		model : 'App.model.User',
		autoLoad : true,
		autoSync : true,
		batchActions: false,
		proxy : {
			batchActions: false,
			type : 'ajax',
			api : {
				read : '/users/read',
				create : '/users/create',
				update : '/users/update',
				destroy : '/users/destroy'
			},
			reader : {
				type : 'json',
				idProperty: '_id',
			},
			writer : {
				type : 'json',
				writeAllFields: true,
			},
			listeners : {
				exception : function(proxy, response, operation) {
					Ext.MessageBox.show({
						title : 'Exception',
						msg : operation.getError(),
						icon : Ext.MessageBox.ERROR,
						buttons : Ext.Msg.OK
					});
				}
			}
		}
	});
	
	// var rowEditing = Ext.create('Ext.grid.plugin.RowEditing', {
        // clicksToMoveEditor: 1,
        // autoCancel: false
    // });
    
    var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
        clicksToEdit: 1
    });

    var grid = Ext.create('Ext.grid.Panel',{
		plugins: [cellEditing],
		region : 'center',
		layout : 'anchor',
		frame : true,
		store: store,
		autoScroll: true,
		tbar: [{
			text: 'Reset Password',
			handler: function() {
				var selection = grid.getSelectionModel().getLastSelected();
				if(selection) {
					Ext.Ajax.request({
						url: '/admin/reset',
						params: {
							'_id':selection.get('_id')
						},
						callback: function(options,success,response) {
							var res = JSON.parse(response.responseText);
							if(res.success) {
								Ext.Msg.show({
									title : 'Admin',
									msg : 'Password reset succeeded. Password reset URL: /login/reset/'+res.code+'. '+ res.message,
									buttons : Ext.Msg.OK,
									iconCls : 'lock'
								});
							} else {
								Ext.Msg.show({
									title : 'Admin',
									msg : 'Password reset failed: '+res.message,
									buttons : Ext.Msg.OK,
									iconCls : 'lock'
								});
							}
						}, 
					})
				}
			}, 
			scope: this,
		}],
		columns: [{
            text: 'ID',
            width: 40,
            sortable: true,
            dataIndex: '_id'
        }, {
            header: 'Email',
            flex: 1,
            sortable: true,
            dataIndex: 'email',
            field: {
                type: 'textfield'
            }
        }, {
            header: 'Name',
            width: 100,
            sortable: true,
            dataIndex: 'name',
            field: {
                type: 'textfield'
            }
        }, {
            header: 'Institution',
            width: 100,
            sortable: true,
            dataIndex: 'institution',
            field: {
                type: 'textfield'
            }
        },{
        	header: 'Active',
        	dataIndex: 'active',
        	xtype: 'checkcolumn',
        	sortable: true,
        	editable: true,
        },{
        	header: 'Admin',
        	dataIndex: 'admin',
        	xtype: 'checkcolumn',
        	sortable: true,
        	editable: true,
        }]
	});
	var adminWindow = Ext.create('Ext.Window',{
		closable : false,
		width : 500,
		height : 300,
		modal : true,
		layout : 'border',
		title : &quot;Administration for &quot; + App.name,
		iconCls : 'lock',
		items : [{
			html : 'Edit users who have access to ' + App.name + '.',
			frame : true,
			region : 'north',
			split : true,
			margins : '5 5 0 5'
		}, grid ]
	});
	adminWindow.show();

});
</pre>
</body>
</html>
